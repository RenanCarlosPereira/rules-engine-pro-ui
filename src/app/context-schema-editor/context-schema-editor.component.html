<div class="border rounded-xl p-4 mb-4 shadow-md transition-all duration-300 bg-white">
  <!-- Header -->
  <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
    <div class="flex items-center gap-2">
      <i-lucide [img]="LayoutGridIcon" class="w-5 h-5 text-blue-600"></i-lucide>
      <h2 class="text-lg font-semibold text-gray-800">Input</h2>
    </div>

    <div class="flex items-center gap-2 mb-2">
      <label class="text-sm font-medium text-gray-700">Rule:</label>
      <select class="border rounded-md px-2 py-1 text-sm" [(ngModel)]="selectedRule">
        <option [ngValue]="null">-- Select rule --</option>
        <option *ngFor="let entry of availableRules" [ngValue]="entry.rule">
          {{ 'â€”'.repeat(entry.depth) }} {{ entry.rule.RuleName }}
        </option>
      </select>
    </div>

    <div class="flex gap-2 flex-wrap justify-end">
      <button (click)="loadSchema()"
        class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition">
        Load Schema
      </button>

      <button (click)="logContext()"
        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center gap-1">
        <i-lucide [img]="CheckCircleIcon" class="w-4 h-4"></i-lucide> Build Context
      </button>
    </div>
  </div>

  <p class="text-sm text-gray-600 mb-4">
    Configure your context by selecting the expected types and values based on the loaded JSON schema.
  </p>

  <!-- Schema Editor -->
  <ng-container *ngIf="schema; else loading">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-3 gap-4">
      <div *ngFor="let path of fieldPaths"
        class="flex flex-col border border-gray-200 rounded-lg p-4 bg-white shadow-sm text-sm gap-2">
        <label class="font-medium text-gray-700 flex items-center gap-1">
          <i-lucide [img]="FileTextIcon" class="w-4 h-4 text-gray-500"></i-lucide>
          {{ path }}
        </label>

        <ng-container *ngIf="fieldMap[path]">
          <!-- Type Selector -->
          <select [(ngModel)]="fieldMap[path].type" class="border px-2 py-1 rounded text-sm mb-1">
            <option value="">-- Select type --</option>
            <option *ngFor="let type of supportedTypes" [value]="type">{{ type }}</option>
          </select>

          <!-- Value Input -->
          <ng-container [ngSwitch]="fieldMap[path].type">
            <input *ngSwitchCase="'string'" type="text" class="border px-2 py-1 rounded text-sm"
              [(ngModel)]="fieldMap[path].value" />
            <input *ngSwitchCase="'number'" type="number" class="border px-2 py-1 rounded text-sm"
              [(ngModel)]="fieldMap[path].value" />
            <label *ngSwitchCase="'boolean'" class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" [(ngModel)]="fieldMap[path].value" />
              <span class="text-sm">True / False</span>
            </label>
            <textarea *ngSwitchCase="'object'" class="border px-2 py-1 rounded text-sm h-24"
              [(ngModel)]="fieldMap[path].value"></textarea>
          </ng-container>
        </ng-container>
      </div>
    </div>

    <!-- JSON Editor Output -->
    <div class="mt-6">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">Generated Context</h4>
      <div class="overflow-auto max-h-[60vh]">
        <app-expression-builder [value]="finalContext | json" [languageName]="'json'"></app-expression-builder>
      </div>
    </div>
  </ng-container>

  <ng-template #loading>
    <p class="text-sm text-gray-500 italic">
      Schema not loaded yet. Click "Load Schema" to start.
    </p>
  </ng-template>
</div>
